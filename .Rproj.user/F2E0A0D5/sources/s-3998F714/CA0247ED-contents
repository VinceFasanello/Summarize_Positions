---
title: "R Notebook"
output: html_notebook
---

```{r}
rm(list = ls())
`%notin%` <- Negate(`%in%`)


# read etf files.
ETFS <- c("CNRG", "FAN", "ICLN", "MJ", "PBD", "PBW", "QCLN", "TAN", "UFO")
for (i in ETFS) {
  temp <- read.csv(file = paste0("ETF_",i,".csv"))
  colnames(temp) <- c("Symbol", "Description", "Country", "Weight")
  temp <- temp[temp$Symbol != "",]
  temp$Weight <- temp$Weight/sum(temp$Weight) # holding weights sum to 1 within each ETF.
  assign(paste0(i), temp)
}; rm(temp, i)


# read account summary file and split between etfs and other holidngs.
accSUM <- read.csv(file = "Portfolio_Positions_Nov-14-2020_MODIFIED.csv")
colnames(accSUM)[1] <- "Symbol"
accSUM$CVW <- accSUM$CurrentValue / sum(accSUM$CurrentValue, na.rm = T)
accSUMetf <- accSUM[accSUM$Symbol %in% ETFS,]
accSUMother <- accSUM[accSUM$Symbol %notin% ETFS,]
rm(accSUM)
accSUMetf <- accSUMetf[match(ETFS, accSUMetf$Symbol),] # match to ETFS order above. 
```

```{r}
# calculate account weight for each ETF entry 
for (i in ETFS) {
  temp <- get(i)
  temp$CVW <- NA; temp$CBW <- NA
  temp$CVW <- temp$Weight*accSUMetf[accSUMetf$Symbol == i,]$CVW
  assign(paste0(i), temp)
}; rm(temp, i)
```

```{r}
# generate dataframe with all holdings
holdings <- NA
for(i in ETFS){
    temp <- get(i)
    holdings <- rbind(holdings, temp)
}; rm(temp, i); holdings <- holdings[2:nrow(holdings), ]


# list of unique holdings
holdingNames <- unique(holdings$Symbol)
```

```{r}
# summarize by symbol
holdingsSummary <- data.frame(matrix(NA, ncol = 4, nrow = length(holdingNames)))
rownames(holdingsSummary) <- holdingNames
colnames(holdingsSummary) <- c("Symbol", "Description", "Country", "CVW")
holdingsSummary$Symbol <- holdingNames

for (i in holdingNames) {
  temp <- holdings[holdings$Symbol == i,]
  holdingsSummary[holdingsSummary$Symbol == i,]$Description <- temp$Description[1]
  holdingsSummary[holdingsSummary$Symbol == i,]$Country <- temp$Country[1]
  holdingsSummary[holdingsSummary$Symbol == i,]$CVW <- sum(temp$CVW, na.rm = T)
}; rm(holdingNames, i)
```

```{r}
# concatonate with non etf holdings
accSUMother <- accSUMother[,c("Symbol", "Description", "Country", "CVW")]
colnames(accSUMother)[3] <- "Country"
myAccount <- rbind(accSUMother, holdingsSummary)
myAccount$CVW <- myAccount$CVW*100
myAccount <- myAccount[order(myAccount$CVW, decreasing = T),]
myAccount$Country <- as.factor(myAccount$Country)
```

```{r}
# visualize
hist(myAccount$CVW, breaks = 100)
hist(myAccount$CVW[myAccount$CVW < 5], breaks = 100)
hist(myAccount$CVW[myAccount$CVW < 1], breaks = 100)

mySummary <- cbind(
  aggregate(myAccount$CVW, by=list(Category=myAccount$Country), FUN=sum),
  aggregate(myAccount$CVW, by=list(Category=myAccount$Country), FUN=length)[,2]

)
mySummary <- mySummary[order(mySummary[,2], decreasing = T),]
colnames(mySummary) <- c("Country", "CVW", "nHoldings")
```


